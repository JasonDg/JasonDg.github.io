<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>通过 corepack 使用 pnpm 与 yarn 作为包管理器 | JasonDG</title><meta name=keywords content="pnpm,yarn,nodejs"><meta name=description content="Node.js 16 中加入了 corepack 工具，能够直接启用 pnpm 与 yarn 作为包管理器，而不需要通过 npm 进行额外的安装。 尝试了在日常开发中使用 pnpm 与 yarn 替代 npm,记录了一些体验上的"><meta name=author content><link rel=canonical href=https://jasondg.github.io/posts/try.pnpm.and.yarn/><link crossorigin=anonymous href=/assets/css/stylesheet.min.48a18943c2fc15c38a372b8dde1f5e5dc0bc64fa6cb90f5a817d2f8c76b7f3ae.css integrity="sha256-SKGJQ8L8FcOKNyuN3h9eXcC8ZPpsuQ9agX0vjHa3864=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://jasondg.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jasondg.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jasondg.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://jasondg.github.io/apple-touch-icon.png><link rel=mask-icon href=https://jasondg.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://jasondg.github.io/posts/try.pnpm.and.yarn/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="通过 corepack 使用 pnpm 与 yarn 作为包管理器"><meta property="og:description" content="Node.js 16 中加入了 corepack 工具，能够直接启用 pnpm 与 yarn 作为包管理器，而不需要通过 npm 进行额外的安装。 尝试了在日常开发中使用 pnpm 与 yarn 替代 npm,记录了一些体验上的"><meta property="og:type" content="article"><meta property="og:url" content="https://jasondg.github.io/posts/try.pnpm.and.yarn/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-03T21:02:50+08:00"><meta property="article:modified_time" content="2022-04-04T00:36:49+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="通过 corepack 使用 pnpm 与 yarn 作为包管理器"><meta name=twitter:description content="Node.js 16 中加入了 corepack 工具，能够直接启用 pnpm 与 yarn 作为包管理器，而不需要通过 npm 进行额外的安装。 尝试了在日常开发中使用 pnpm 与 yarn 替代 npm,记录了一些体验上的"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://jasondg.github.io/posts/"},{"@type":"ListItem","position":2,"name":"通过 corepack 使用 pnpm 与 yarn 作为包管理器","item":"https://jasondg.github.io/posts/try.pnpm.and.yarn/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"通过 corepack 使用 pnpm 与 yarn 作为包管理器","name":"通过 corepack 使用 pnpm 与 yarn 作为包管理器","description":"Node.js 16 中加入了 corepack 工具，能够直接启用 pnpm 与 yarn 作为包管理器，而不需要通过 npm 进行额外的安装。 尝试了在日常开发中使用 pnpm 与 yarn 替代 npm,记录了一些体验上的","keywords":["pnpm","yarn","nodejs"],"articleBody":"Node.js 16 中加入了 corepack 工具，能够直接启用 pnpm 与 yarn 作为包管理器，而不需要通过 npm 进行额外的安装。\n尝试了在日常开发中使用 pnpm 与 yarn 替代 npm,记录了一些体验上的优化和实际使用中遇到的问题。\n通过 corepack 启用 pnpm 与 yarn corepack 目前还是实验性功能，需要按照文档1进行手动开启。\n 执行 corepack enable （如果 Node.js 未以 user 权限进行安装，需要 sudo 或 root 权限进行运行，windows 上需要以管理员模式运行） 配置 package.json 中的 packageManager （使用 pnpm 时即使不配置也可正常使用，使用 yarn 时如果不进行packageManager的配置，会使用 yarn 1 而非 yarn 2+） 如果需要在离线环境下启用，可以使用 corepack prepare 进行预载  pnpm 与 yarn 的优势 Phantom dependencies Phantom dependencies 是指依赖被安装后，非该依赖链上的代码也可以使用该依赖，例如\n// root { \"dependencies\": { \"a\": \"^1.0.0\", \"c\": \"^1.0.0\" } } // a { \"dependencies\": { \"b\": \"^1.0.0\" } } 安装后文件路径为\n/node_modules /a /b /c 其中 b 依赖可以被直接import/require，这造成了隐式依赖，可能出现不易发现的问题，详细说明可以参见 rushjs 的解释2。\nNPM doppelgangers NPM doppelgangers 是指同一依赖存在不同版本时，尽管 npm 进行了 hoist，仍会产生多个重复的依赖包，例如\n{ \"dependencies\": { \"a\": \"^1.0.0\", = { \"e\": \"^1.0.0\" } \"b\": \"^1.0.0\", = { \"e\": \"^1.0.0\" } \"c\": \"^1.0.0\", = { \"e\": \"^2.0.0\" } \"d\": \"^1.0.0\" = { \"e\": \"^2.0.0\" } } } 安装后文件路径为\n// npm 进行 hoist /node_modules /a /b /c /e@2 /d /e@2 /e@1 // 或 /node_modules /a /e@1 /b /e@1 /c /d /e@2 这样会导致重复依赖的存在不可避免，影响性能甚至会导致编译工具的一些 bug，详细说明可以参见 rushjs 的解释3。\npnpm 与 yarn 的优化 pnpm 采用 symlink 方式4，在项目中通过建立共享存储的 hardlink 来创建非平铺（non-flat）的 node_modules，从而避免了上述的问题，同时也减少了硬盘空间的占用。\nyarn (2+) 采用 Plug’n’Play 方式，通过一个 cjs 控制依赖的加载，以 zip 方式提供依赖，从而能够约束 phantom dependencies 问题，同时减少了硬盘的 IO。\n并且在这种方式下，将依赖 commit 进 git 成为可能，配合 yarn 的 zero install 功能，能够使项目更加稳健，不因依赖安装产生问题。\n使用中的一些问题 yarn 在遇到一些不很规范的包时，yarn PnP 会因为包调用 phantom dependencies 而出现依赖缺失，需要使用 loose 模式5绕过。\n同时，yarn PnP 会以 zip 格式安装依赖，需要额外安装 sdk 与相关插件等使编辑器能够正常工作，在一些受限环境下使用不友好。\npnpm 使用 hardlink 创建 non-flat 的 node_modules 有时候会导致文件读取问题。\n一个例子为，曾经遇到过在 Windows 10 环境下，通过 vite 运行依赖 @mui/icons-material 的应用时，出现 too many files 问题。\n临时的解决方案为使用\n// ok import { xxx } from \"@mui/icons-material/XXX\" 替代\n// error: too many files import { xxx } from \"@mui/icons-material\" 但这个问题在 Linux 下没能复现，不能确定是什么原因。并且由于手边没有能复现的环境，暂时也不能排查问题。\n总结 Node.js 增加 corepack 后，相信 yarn 与 pnpm 会被更为广泛地应用，从而解决一些 npm 一直存在的问题。\n从个人使用角度，yarn 与 pnpm 也确实提升了体验与开发效率，值得作为 Node.js 下主要的包管理工具。\n  https://nodejs.org/api/corepack.html#workflows ↩︎\n https://rushjs.io/pages/advanced/phantom_deps/ ↩︎\n https://rushjs.io/pages/advanced/npm_doppelgangers/ ↩︎\n https://pnpm.io/motivation ↩︎\n https://yarnpkg.com/features/pnp#pnp-loose-mode ↩︎\n   ","wordCount":"1062","inLanguage":"zh","datePublished":"2022-04-03T21:02:50+08:00","dateModified":"2022-04-04T00:36:49+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jasondg.github.io/posts/try.pnpm.and.yarn/"},"publisher":{"@type":"Organization","name":"JasonDG","logo":{"@type":"ImageObject","url":"https://jasondg.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jasondg.github.io/ accesskey=h title="JasonDG (Alt + H)">JasonDG</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://jasondg.github.io/en/ title=English aria-label=English>English</a></li></ul></span></div><ul id=menu><li><a href=https://jasondg.github.io/archives/ title=文章><span>文章</span></a></li><li><a href=https://jasondg.github.io/categories/ title=分类><span>分类</span></a></li><li><a href=https://jasondg.github.io/tags/ title=标签><span>标签</span></a></li><li><a href=https://jasondg.github.io/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>通过 corepack 使用 pnpm 与 yarn 作为包管理器</h1><div class=post-meta><span title="2022-04-03 21:02:50 +0800 +0800">四月 3, 2022</span>&nbsp;·&nbsp;3 分钟</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e9%80%9a%e8%bf%87-corepack-%e5%90%af%e7%94%a8-pnpm-%e4%b8%8e-yarn aria-label="通过 corepack 启用 pnpm 与 yarn">通过 corepack 启用 pnpm 与 yarn</a></li><li><a href=#pnpm-%e4%b8%8e-yarn-%e7%9a%84%e4%bc%98%e5%8a%bf aria-label="pnpm 与 yarn 的优势">pnpm 与 yarn 的优势</a><ul><li><a href=#phantom-dependencies aria-label="Phantom dependencies">Phantom dependencies</a></li><li><a href=#npm-doppelgangers aria-label="NPM doppelgangers">NPM doppelgangers</a></li><li><a href=#pnpm-%e4%b8%8e-yarn-%e7%9a%84%e4%bc%98%e5%8c%96 aria-label="pnpm 与 yarn 的优化">pnpm 与 yarn 的优化</a></li></ul></li><li><a href=#%e4%bd%bf%e7%94%a8%e4%b8%ad%e7%9a%84%e4%b8%80%e4%ba%9b%e9%97%ae%e9%a2%98 aria-label=使用中的一些问题>使用中的一些问题</a><ul><li><a href=#yarn aria-label=yarn>yarn</a></li><li><a href=#pnpm aria-label=pnpm>pnpm</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></li></ul></div></details></div><div class=post-content><p>Node.js 16 中加入了 <a href=https://nodejs.org/api/corepack.html>corepack</a> 工具，能够直接启用 pnpm 与 yarn 作为包管理器，而不需要通过 npm 进行额外的安装。</p><p>尝试了在日常开发中使用 pnpm 与 yarn 替代 npm,记录了一些体验上的优化和实际使用中遇到的问题。</p><h1 id=通过-corepack-启用-pnpm-与-yarn>通过 corepack 启用 pnpm 与 yarn<a hidden class=anchor aria-hidden=true href=#通过-corepack-启用-pnpm-与-yarn>#</a></h1><p>corepack 目前还是实验性功能，需要按照文档<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>进行手动开启。</p><ul><li>执行 <code>corepack enable</code> （如果 Node.js 未以 user 权限进行安装，需要 sudo 或 root 权限进行运行，windows 上需要以管理员模式运行）</li><li>配置 <code>package.json</code> 中的 <code>packageManager</code> （使用 pnpm 时即使不配置也可正常使用，使用 yarn 时如果不进行<code>packageManager</code>的配置，会使用 yarn 1 而非 yarn 2+）</li><li>如果需要在离线环境下启用，可以使用 <code>corepack prepare</code> 进行预载</li></ul><h1 id=pnpm-与-yarn-的优势>pnpm 与 yarn 的优势<a hidden class=anchor aria-hidden=true href=#pnpm-与-yarn-的优势>#</a></h1><h2 id=phantom-dependencies>Phantom dependencies<a hidden class=anchor aria-hidden=true href=#phantom-dependencies>#</a></h2><p>Phantom dependencies 是指依赖被安装后，非该依赖链上的代码也可以使用该依赖，例如</p><pre tabindex=0><code>// root
{
    &#34;dependencies&#34;: {
        &#34;a&#34;: &#34;^1.0.0&#34;,
        &#34;c&#34;: &#34;^1.0.0&#34;
    }
}

// a
{
    &#34;dependencies&#34;: {
        &#34;b&#34;: &#34;^1.0.0&#34;
    }
}
</code></pre><p>安装后文件路径为</p><pre tabindex=0><code>/node_modules
    /a
    /b
    /c
</code></pre><p>其中 b 依赖可以被直接<code>import</code>/<code>require</code>，这造成了隐式依赖，可能出现不易发现的问题，详细说明可以参见 rushjs 的解释<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>。</p><h2 id=npm-doppelgangers>NPM doppelgangers<a hidden class=anchor aria-hidden=true href=#npm-doppelgangers>#</a></h2><p>NPM doppelgangers 是指同一依赖存在不同版本时，尽管 npm 进行了 hoist，仍会产生多个重复的依赖包，例如</p><pre tabindex=0><code>{
    &#34;dependencies&#34;: {
        &#34;a&#34;: &#34;^1.0.0&#34;, =&gt; { &#34;e&#34;: &#34;^1.0.0&#34; }
        &#34;b&#34;: &#34;^1.0.0&#34;, =&gt; { &#34;e&#34;: &#34;^1.0.0&#34; }
        &#34;c&#34;: &#34;^1.0.0&#34;, =&gt; { &#34;e&#34;: &#34;^2.0.0&#34; }
        &#34;d&#34;: &#34;^1.0.0&#34;  =&gt; { &#34;e&#34;: &#34;^2.0.0&#34; }
    }
}
</code></pre><p>安装后文件路径为</p><pre tabindex=0><code>// npm 进行 hoist

/node_modules
    /a
    /b
    /c
        /e@2
    /d
        /e@2
    /e@1

// 或

/node_modules
    /a
        /e@1
    /b
        /e@1
    /c
    /d
    /e@2
</code></pre><p>这样会导致重复依赖的存在不可避免，影响性能甚至会导致编译工具的一些 bug，详细说明可以参见 rushjs 的解释<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>。</p><h2 id=pnpm-与-yarn-的优化>pnpm 与 yarn 的优化<a hidden class=anchor aria-hidden=true href=#pnpm-与-yarn-的优化>#</a></h2><p>pnpm 采用 symlink 方式<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>，在项目中通过建立共享存储的 hardlink 来创建非平铺（non-flat）的 node_modules，从而避免了上述的问题，同时也减少了硬盘空间的占用。</p><p>yarn (2+) 采用 <a href=https://yarnpkg.com/features/pnp>Plug&rsquo;n&rsquo;Play</a> 方式，通过一个 cjs 控制依赖的加载，以 zip 方式提供依赖，从而能够约束 phantom dependencies 问题，同时减少了硬盘的 IO。<br>并且在这种方式下，将依赖 commit 进 git 成为可能，配合 yarn 的 <a href=https://yarnpkg.com/features/zero-installs/>zero install</a> 功能，能够使项目更加稳健，不因依赖安装产生问题。</p><h1 id=使用中的一些问题>使用中的一些问题<a hidden class=anchor aria-hidden=true href=#使用中的一些问题>#</a></h1><h2 id=yarn>yarn<a hidden class=anchor aria-hidden=true href=#yarn>#</a></h2><p>在遇到一些不很规范的包时，yarn PnP 会因为包调用 phantom dependencies 而出现依赖缺失，需要使用 loose 模式<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>绕过。</p><p>同时，yarn PnP 会以 zip 格式安装依赖，需要额外安装 <a href=https://yarnpkg.com/getting-started/editor-sdks/>sdk</a> 与相关插件等使编辑器能够正常工作，在一些受限环境下使用不友好。</p><h2 id=pnpm>pnpm<a hidden class=anchor aria-hidden=true href=#pnpm>#</a></h2><p>使用 hardlink 创建 non-flat 的 node_modules 有时候会导致文件读取问题。<br>一个例子为，曾经遇到过在 Windows 10 环境下，通过 vite 运行依赖 @mui/icons-material 的应用时，出现 too many files 问题。<br>临时的解决方案为使用</p><pre tabindex=0><code>// ok
import { xxx } from &#34;@mui/icons-material/XXX&#34;
</code></pre><p>替代</p><pre tabindex=0><code>// error: too many files
import { xxx } from &#34;@mui/icons-material&#34;
</code></pre><p>但这个问题在 Linux 下没能复现，不能确定是什么原因。并且由于手边没有能复现的环境，暂时也不能排查问题。</p><h1 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h1><p>Node.js 增加 corepack 后，相信 yarn 与 pnpm 会被更为广泛地应用，从而解决一些 npm 一直存在的问题。</p><p>从个人使用角度，yarn 与 pnpm 也确实提升了体验与开发效率，值得作为 Node.js 下主要的包管理工具。</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://nodejs.org/api/corepack.html#workflows>https://nodejs.org/api/corepack.html#workflows</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://rushjs.io/pages/advanced/phantom_deps/>https://rushjs.io/pages/advanced/phantom_deps/</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p><a href=https://rushjs.io/pages/advanced/npm_doppelgangers/>https://rushjs.io/pages/advanced/npm_doppelgangers/</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p><a href=https://pnpm.io/motivation>https://pnpm.io/motivation</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5 role=doc-endnote><p><a href=https://yarnpkg.com/features/pnp#pnp-loose-mode>https://yarnpkg.com/features/pnp#pnp-loose-mode</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><footer class=post-footer><ul class=post-tags><li><a href=https://jasondg.github.io/tags/pnpm/>pnpm</a></li><li><a href=https://jasondg.github.io/tags/yarn/>yarn</a></li><li><a href=https://jasondg.github.io/tags/nodejs/>nodejs</a></li></ul><nav class=paginav><a class=next href=https://jasondg.github.io/posts/container.websocket.502/><span class=title>下一页 »</span><br><span>端口映射后容器内 WebSocket 产生 502 Bad Gateway 错误</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://jasondg.github.io/>JasonDG</a></span>
&bull;
<span>使用 <a href=http://creativecommons.org/licenses/by-sa/4.0 target=_blank>CC BY-SA 4.0</a> 许可</span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="复制";function s(){e.innerText="已复制！",setTimeout(()=>{e.innerText="复制"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>